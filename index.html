<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exchanger Pro - Trusted Platform</title>
    <meta name="theme-color" content="#4F46E5">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { 
            --primary-color: #4F46E5;
            --primary-light: #818CF8;
            --accent-color: #10B981;
            --bg-body: #F3F4F6;
            --text-main: #1F2937;
            --gradient-main: linear-gradient(135deg, var(--primary-color) 0%, #7C3AED 100%);
            --shadow-card: 0 4px 20px rgba(79, 70, 229, 0.08);
            --radius-card: 20px;
        }
        
        body { background-color: var(--bg-body); font-family: 'Segoe UI', sans-serif; color: var(--text-main); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .page-container { padding-bottom: 80px; padding-top: 15px; }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 10px; }

        .swal2-popup.swal2-toast { background: #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-radius: 12px; padding: 10px 20px; border-left: 5px solid var(--primary-color); }
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 8px; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .swal2-container { z-index: 99999 !important; }

        /* Navbar */
        .navbar { background: var(--gradient-main) !important; box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 10px 0; position: sticky; top: 0; z-index: 1001; }
        .brand-logo-link { display: flex; align-items: center; text-decoration: none; gap: 10px; }
        .logo-icon-custom { width: 38px; height: 38px; background: rgba(255,255,255,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.3); }
        .logo-icon-custom svg { width: 20px; height: 20px; fill: white; }
        .logo-title { font-size: 18px; font-weight: 800; color: #fff; letter-spacing: 0.5px; }
        .logo-subtitle { font-size: 9px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        /* Bottom Nav */
        .nav-bottom { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255,255,255,0.98); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 6px 0 12px 0; z-index: 1000; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); }
        .nav-item { color: #6B7280; font-size: 10px; font-weight: 600; transition: 0.2s; width: 25%; text-align: center; padding: 4px 0; cursor: pointer; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item i { font-size: 22px; margin-bottom: 2px; display: block; transition: transform 0.2s; }
        .nav-item:active i { transform: scale(1.2); }
        
        /* Components */
        .social-float { position: fixed; bottom: 85px; right: 15px; display: flex; flex-direction: column; gap: 12px; z-index: 999; }
        .float-btn { width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); color: white; transition: transform 0.2s; }
        .float-btn:active { transform: scale(0.9); }
        .wa-btn { background-color: #25D366; }
        .tg-btn { background: linear-gradient(135deg, #0088cc 0%, #0055aa 100%); }
        
        /* --- COMMON CARD STYLE --- */
        .home-card {
            background: white;
            border-radius: var(--radius-card);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(255,255,255,0.5);
            animation: fadeInUp 0.5s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- RATE DISPLAY DESIGN (Like Screenshot) --- */
        .rate-card-v2 {
            background: white;
            border-radius: 16px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .rate-card-header {
            background: #f8fafc;
            padding: 12px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .level-badge-v2 {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 700;
            color: #4F46E5;
            font-size: 14px;
        }
        .level-badge-v2 i { font-size: 16px; }
        
        .rate-grid-v2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            padding: 15px;
            gap: 15px;
        }
        .rate-box-v2 {
            background: #f9fafb;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid #f3f4f6;
        }
        .rate-box-v2.new { border-left: 4px solid #10b981; }
        .rate-box-v2.old { border-left: 4px solid #8b5cf6; }
        
        .rb-title { font-size: 12px; color: #6b7280; font-weight: 600; margin-bottom: 5px; }
        .rb-value { font-size: 22px; font-weight: 800; color: #111827; }
        .rb-value small { font-size: 11px; font-weight: 600; color: #9ca3af; }

        /* Review Time Card */
        .review-time-card { display: flex; align-items: center; justify-content: space-between; position: relative; overflow: hidden; }
        .review-time-card::before { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 100px; background: linear-gradient(90deg, transparent, rgba(79, 70, 229, 0.03)); }
        .rtc-left { display: flex; align-items: center; gap: 15px; }
        .rtc-icon-box { width: 50px; height: 50px; background: rgba(79, 70, 229, 0.1); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 22px; color: var(--primary-color); position: relative; }
        .rtc-icon-box::after { content: ''; position: absolute; width: 100%; height: 100%; border-radius: 14px; border: 2px solid var(--primary-color); opacity: 0.1; }
        .rtc-info h6 { margin: 0; font-size: 12px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .rtc-info h4 { margin: 0; font-size: 18px; font-weight: 800; color: #111827; margin-top: 2px; }
        .rtc-right { text-align: right; position: relative; z-index: 1; }
        .rtc-status-badge { display: inline-flex; align-items: center; gap: 5px; background: #ecfdf5; color: #059669; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; margin-bottom: 5px; }
        .pulse-dot { width: 6px; height: 6px; background: #10b981; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 70% { box-shadow: 0 0 0 6px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        .rtc-clock-text { font-size: 16px; font-weight: 800; color: var(--primary-color); font-family: monospace; }

        /* Transaction Card */
        .trans-card { border: 1px solid rgba(255,255,255,0.5); }
        .trans-btn { background: var(--gradient-main); color: white; border: none; padding: 14px; border-radius: 14px; font-weight: 700; width: 100%; font-size: 16px; transition: 0.2s; box-shadow: 0 4px 15px rgba(79, 70, 229, 0.2); display: flex; align-items: center; justify-content: center; gap: 8px; }
        .trans-btn:active { transform: scale(0.98); box-shadow: 0 2px 5px rgba(79, 70, 229, 0.2); }
        .trans-btn:disabled { background: #9ca3af; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .form-select-custom {
            background-color: #f3f4f6;
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 12px 16px;
            font-weight: 600;
            color: #374151;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px 12px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .form-select-custom:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: #fff;
        }

        /* Trust Box */
        .trust-box-new { text-align: center; }
        .tbn-title { font-size: 14px; font-weight: 700; color: #374151; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .tbn-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .tbn-item { background: #f9fafb; border-radius: 16px; padding: 15px 5px; transition: all 0.2s; border: 1px solid transparent; }
        .tbn-item:active { transform: scale(0.95); border-color: #e5e7eb; }
        .tbn-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; color: white; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .tbn-icon.t1 { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .tbn-icon.t2 { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .tbn-icon.t3 { background: linear-gradient(135deg, #10b981, #059669); }
        .tbn-text { font-size: 11px; font-weight: 700; color: #4b5563; }

        /* Gmail Row */
        .gmail-row { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; position: relative; border: 1px solid #e5e7eb; transition: all 0.3s; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .gmail-row:focus-within { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1); }
        .gmail-row input { border: none; background: #f9fafb; border-radius: 8px; padding: 10px; font-size: 14px; width: 100%; margin-bottom: 8px; }
        .gmail-row .remove-btn { position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; font-size: 14px; line-height: 1; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* History Tabs */
        .history-tabs-container { background: white; padding: 8px; border-radius: 20px; margin-bottom: 15px; box-shadow: var(--shadow-card); border: 1px solid #f3f4f6; }
        .history-tabs { display: flex; gap: 8px; }
        .h-tab-btn { flex: 1; border: none; background: transparent; padding: 12px 5px; font-weight: 600; color: #6B7280; font-size: 11px; border-radius: 16px; transition: 0.3s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .h-tab-btn i { font-size: 20px; transition: 0.3s; }
        .h-tab-btn.active { background: var(--gradient-main); color: white; transform: scale(1.02); box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3); }

        /* Top Sellers */
        .seller-card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px; display: flex; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.03); border: 1px solid #f3f4f6; transition: 0.2s; }
        .seller-card:active { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.06); }
        .seller-rank { width: 45px; height: 45px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-weight: 900; margin-right: 15px; color: #6B7280; font-size: 16px; flex-shrink: 0; }
        .seller-rank.gold { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3); }
        .seller-rank.silver { background: linear-gradient(135deg, #C0C0C0, #A9A9A9); color: white; }
        .seller-info { flex-grow: 1; }
        .seller-name { font-weight: 700; font-size: 15px; color: #111827; }
        .seller-income-label { font-size: 11px; color: #9ca3af; font-weight: 600; }
        .seller-amount { font-weight: 800; color: var(--primary-color); font-size: 18px; text-align: right; }
        .seller-amount small { font-size: 11px; font-weight: 600; color: #6b7280; }

        /* PROFILE DESIGN */
        .profile-header { background: var(--gradient-main); padding: 30px 20px 70px; margin: -15px -15px 20px -15px; color: white; text-align: center; position: relative; border-radius: 0 0 30px 30px; }
        .ph-logo-custom { width: 80px; height: 80px; background: rgba(255,255,255,0.2); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; border: 3px solid rgba(255,255,255,0.3); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .ph-logo-custom svg { width: 40px; height: 40px; fill: white; }
        .ph-name { font-size: 22px; font-weight: 700; margin-bottom: 5px; }
        .balance-card-profile { background: white; border-radius: 20px; padding: 20px; margin: -50px auto 20px; position: relative; z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 100%; display: flex; justify-content: space-around; align-items: center; }
        .bal-icon-box { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; margin-bottom: 5px; }
        .bal-main .bal-icon-box { background: #e0e7ff; color: var(--primary-color); }
        .bal-hold .bal-icon-box { background: #fef3c7; color: #d97706; }
        
        .withdraw-main-btn { display: flex; align-items: center; justify-content: center; gap: 10px; background: white; border: 2px solid var(--primary-color); color: var(--primary-color); padding: 15px; border-radius: 16px; width: 100%; font-weight: 700; font-size: 16px; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.1); transition: 0.2s; margin-bottom: 20px; }
        .withdraw-main-btn:active { background: var(--primary-color); color: white; }

        .stats-card-mobile { border-radius: 16px; overflow: hidden; margin-bottom: 20px; box-shadow: var(--shadow-card); border: none; }
        .stat-box { background: #f8fafc; border-radius: 12px; padding: 15px 10px; text-align: center; height: 100%; transition: all 0.2s; border: 1px solid transparent; }
        .stat-box:active { border-color: var(--primary-color); transform: scale(0.98); }
        .stat-box .val { font-size: 22px; font-weight: 800; margin-bottom: 2px; display: block; }
        .stat-box .label { font-size: 11px; color: #6b7280; font-weight: 600; text-transform: uppercase; }
        .stat-box.total .val { color: var(--primary-color); }
        .stat-box.pend .val { color: #eab308; }
        .stat-box.app .val { color: #22c55e; }
        .stat-box.rej .val { color: #ef4444; }

        .level-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow-card); border: 1px solid #f3f4f6; }
        .progress { transition: width 1s ease-in-out; }

        .referral-card-new { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 25px 20px; color: white; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3); }
        .ref-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; text-align: center; }
        .ref-stat-val { font-size: 26px; font-weight: 800; }
        .ref-stat-label { font-size: 11px; opacity: 0.9; text-transform: uppercase; }
        .ref-input-group { background: rgba(255,255,255,0.15); border-radius: 12px; padding: 12px; display: flex; align-items: center; gap: 10px; }
        .ref-code-text { font-size: 18px; font-weight: 700; letter-spacing: 1px; color: #fff; }

        /* Settings Menu */
        .settings-card { background: white; border-radius: 16px; padding: 10px; margin-bottom: 20px; box-shadow: var(--shadow-card); }
        .settings-item { display: flex; align-items: center; padding: 15px; border-radius: 12px; transition: 0.2s; cursor: pointer; }
        .settings-item:active { background: #f3f4f6; }
        .settings-item i { font-size: 20px; margin-right: 15px; width: 24px; text-align: center; }
        .settings-item .text { flex-grow: 1; }
        .settings-item .text h6 { margin: 0; font-size: 15px; font-weight: 600; color: #111827; }
        .settings-item .text small { color: #6b7280; font-size: 11px; }
        .settings-item.danger i, .settings-item.danger h6 { color: #ef4444; }
        
        /* Auth Page */
        #auth-page { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--gradient-main); z-index: 2000; overflow-y: auto; }
        .auth-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { width: 100%; max-width: 400px; background: #fff; border-radius: 24px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .auth-header { padding: 40px 20px 20px; text-align: center; background: transparent; }
        .auth-logo-box { width: 80px; height: 80px; background: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 2px solid var(--primary-light); }
        .auth-logo-box svg { width: 40px; height: 40px; }
        .auth-title { font-size: 22px; font-weight: 800; margin-bottom: 5px; line-height: 1.3; color: var(--primary-color); }
        .auth-subtitle { font-size: 14px; color: #4B5563; margin-bottom: 10px; opacity: 1; }
        .trust-badges { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
        .trust-badge-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #6B7280; }
        .trust-badge-item i { font-size: 18px; margin-bottom: 4px; color: var(--primary-color); }
        .auth-body { padding: 25px 30px 30px; }
        .form-control { border-radius: 10px; border: 2px solid #eee; font-size: 16px; padding: 12px; transition: border-color 0.2s; }
        .form-control:focus { border-color: var(--primary-light); box-shadow: 0 0 0 0.15rem rgba(79, 70, 229, 0.1); }
        .btn-main { background: var(--gradient-main); border: none; font-weight: 700; border-radius: 12px; padding: 12px; box-shadow: 0 5px 15px rgba(79, 70, 229, 0.2); color: white; width: 100%; position: relative; }
        .btn-main .spinner-border { width: 1.2rem; height: 1.2rem; }

        /* Withdraw Page */
        #withdraw-page { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 1500; overflow-y: auto; animation: slideUp 0.3s ease-out; }
        .wd-header { background: var(--gradient-main); padding: 50px 20px 30px; color: white; text-align: center; border-radius: 0 0 30px 30px; position: relative; }
        .wd-back-btn { position: absolute; top: 15px; left: 15px; background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; font-size: 18px; cursor: pointer; }
        .wd-balance-box { background: rgba(255,255,255,0.15); border-radius: 12px; padding: 15px; margin-top: 15px; }
        .wd-body { padding: 20px; }
        
        .payment-method-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .pm-card { background: white; border: 2px solid #eee; border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer; transition: 0.2s; }
        .pm-card.active { border-color: var(--primary-color); background: rgba(79, 70, 229, 0.05); }
        .pm-card i { font-size: 24px; margin-bottom: 5px; display: block; }
        .pm-card span { font-size: 11px; font-weight: 700; }
        .pm-card.bkash i { color: #E2136E; }
        .pm-card.nagad i { color: #F6921D; }
        .pm-card.binance i { color: #F0B90B; }

        .content-section { display: none; padding: 15px; animation: slideUp 0.3s ease-out; }
        .content-section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<!-- Auth Page -->
<div id="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo-box">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="#4F46E5"/>
                        <path d="M2 17L12 22L22 17" stroke="#4F46E5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2 12L12 17L22 12" stroke="#4F46E5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div id="login-header-content">
                    <div class="auth-title">Welcome Back to Exchanger Pro</div>
                    <div class="auth-subtitle">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶ú ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
                </div>
                <div id="reg-header-content" style="display: none;">
                    <div class="auth-title">Exchanger Pro ‡¶è ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®</div>
                    <div class="auth-subtitle">‡¶¶‡ßç‡¶∞‡ßÅ‡¶§, ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶π‡¶ú‡¶≠‡¶æ‡¶¨‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶è‡¶ñ‡¶®‡¶á ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</div>
                </div>
                <div class="trust-badges" style="margin-top: 25px;">
                    <div class="trust-badge-item"><i class="bi bi-shield-lock-fill"></i><span>Trusted</span></div>
                    <div class="trust-badge-item"><i class="bi bi-lightning-charge-fill"></i><span>Fast</span></div>
                    <div class="trust-badge-item"><i class="bi bi-people-fill"></i><span>50000+ Users</span></div>
                </div>
            </div>
            <div class="auth-body">
                <div id="login-form">
                    <div class="form-floating mb-3"><input type="text" class="form-control" id="loginEmail" placeholder="Email"><label>Gmail Address</label></div>
                    <div class="form-floating mb-4"><input type="password" class="form-control" id="loginPass" placeholder="Password"><label>Password</label></div>
                    <button class="btn btn-main py-3 fw-bold" id="loginBtn" onclick="window.handleLogin()">
                        <span id="loginBtnText">Login</span>
                        <span id="loginBtnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                    <p class="text-center small mt-4 mb-0">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? <a href="#" onclick="toggleAuth('reg')" class="fw-bold" style="color:var(--primary-color)">Register ‡¶ï‡¶∞‡ßÅ‡¶®</a></p>
                </div>
                <div id="reg-form" style="display: none;">
                    <div class="form-floating mb-3"><input type="text" class="form-control" id="regName" placeholder="Name"><label>Full Name</label></div>
                    <div class="form-floating mb-3"><input type="text" class="form-control" id="regEmail" placeholder="Email"><label>Gmail Address</label></div>
                    <div class="form-floating mb-3"><input type="password" class="form-control" id="regPass" placeholder="Pass"><label>Password</label></div>
                    <div class="form-floating mb-4"><input type="password" class="form-control" id="regConfirmPass" placeholder="Confirm"><label>Confirm Password</label></div>
                    <button class="btn btn-main py-3 fw-bold" id="regBtn" onclick="window.handleRegister()">
                        <span id="regBtnText">Register / Sign Up</span>
                        <span id="regBtnSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                    </button>
                    <p class="text-center small mt-4 mb-0">‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá‡¶á ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <a href="#" onclick="toggleAuth('login')" class="fw-bold" style="color:var(--primary-color)">Login ‡¶ï‡¶∞‡ßÅ‡¶®</a></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Withdraw Page -->
<div id="withdraw-page">
    <div class="wd-header">
        <button class="wd-back-btn" onclick="window.closeWithdrawPage()"><i class="bi bi-x-lg"></i></button>
        <h5 class="fw-bold mb-0">Withdraw Funds üí∏</h5>
        <div class="wd-balance-box">
            <div class="d-flex justify-content-around">
                <div><small style="font-size: 10px; opacity: 0.8;">Main Balance</small><h4 class="fw-bold mb-0">‡ß≥ <span id="wdMainBalance">0.00</span></h4></div>
                <div class="border-start"></div>
                <div><small style="font-size: 10px; opacity: 0.8;">Hold Balance</small><h4 class="fw-bold mb-0 text-warning">‡ß≥ <span id="wdHoldBalance">0.00</span></h4></div>
            </div>
        </div>
    </div>
    <div class="wd-body">
        <div class="card p-3 border-0 shadow-sm mb-3">
            <label class="text-muted small fw-bold mb-2">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶•‡¶° ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</label>
            <div class="payment-method-grid">
                <div class="pm-card bkash active" onclick="window.selectPaymentMethod(this, 'bkash')"><i class="bi bi-wallet2"></i><span>bKash</span></div>
                <div class="pm-card nagad" onclick="window.selectPaymentMethod(this, 'nagad')"><i class="bi bi-wallet2"></i><span>Nagad</span></div>
                <div class="pm-card binance" onclick="window.selectPaymentMethod(this, 'binance')"><i class="bi bi-app-indicator"></i><span>USDT</span></div>
            </div>
            <input type="hidden" id="selectedMethod" value="bkash">
        </div>
        <div class="card p-3 border-0 shadow-sm mb-3">
            <div class="mb-3"><label class="form-label text-muted small fw-bold">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞</label><input type="text" class="form-control" id="wdAccNumber" placeholder="Number/Address"></div>
            <div class="mb-3">
                <label class="form-label text-muted small fw-bold">‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</label>
                <input type="number" class="form-control" id="wdAmount" placeholder="Amount" min="100">
                <div class="form-text text-danger small fw-bold" id="wdMinLabel">‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®: 100 ‡¶ü‡¶æ‡¶ï‡¶æ</div>
            </div>
        </div>
        <button class="btn btn-main w-100 py-3 fw-bold" onclick="window.processWithdraw()">Submit Request
 <i class="bi bi-send-check ms-2"></i></button>
    </div>
</div>

<!-- Main App -->
<div class="social-float">
    <a href="https://t.me/gmail_marketing02" target="_blank" class="float-btn tg-btn"><i class="bi bi-telegram"></i></a>
    <a href="https://wa.me/8801964182265" target="_blank" class="float-btn wa-btn"><i class="bi bi-whatsapp"></i></a>
</div>

<nav class="navbar navbar-dark">
    <div class="container d-flex justify-content-center">
        <a class="brand-logo-link" href="#">
            <div class="logo-icon-custom">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="white"/>
                    <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div>
                <span class="logo-title">Exchanger Pro</span>
                <span class="logo-subtitle">Trusted & Fast</span>
            </div>
        </a>
    </div>
</nav>

<div class="container mt-2 page-container">
    
    <!-- HOME PAGE -->
    <div id="home" class="content-section active">
        <div class="alert alert-custom shadow-sm border-0 mb-3" style="background:#fff; border-left:4px solid var(--primary-color); border-radius:12px; display:flex; align-items:center; padding:12px;">
            <i class="bi bi-patch-check-fill text-primary me-3 fs-4"></i> 
            <div class="small"><b>‡ßß‡ß¶‡ß¶% ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ :</b> ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶∏‡¶§‡¶§‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶ø‡¶∏ ‡¶¶‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡•§</div>
        </div>

        <!-- Rate Card V2 (Design like Screenshot) -->
        <div class="rate-card-v2">
            <div class="rate-card-header">
                <div class="level-badge-v2">
                    <i class="bi bi-award-fill"></i>
                    <span id="homeLevelTitle">Level 1 Rate</span>
                </div>
                <div class="dropdown">
                     <span class="badge bg-light text-dark shadow-sm px-2 py-1" style="font-size:10px; border:1px solid #e5e7eb;">Active</span>
                </div>
            </div>
            <div class="rate-grid-v2">
                <div class="rate-box-v2 new">
                    <div class="rb-title">New Gmail</div>
                    <div class="rb-value" id="rateNew">10 <small>‡¶ü‡¶æ‡¶ï‡¶æ</small></div>
                </div>
                <div class="rate-box-v2 old">
                    <div class="rb-title">Old Gmail</div>
                    <div class="rb-value" id="rateOld">8 <small>‡¶ü‡¶æ‡¶ï‡¶æ</small></div>
                </div>
            </div>
        </div>

        <!-- Transaction Card -->
        <div class="home-card trans-card">
            <h6 class="mb-3 fw-bold text-dark"><i class="bi bi-currency-exchange text-primary me-2"></i>‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</h6>
            
            <!-- Dropdown Selection -->
            <div class="mb-3">
                <label class="form-label text-muted small fw-bold">Choose Gmail Type</label>
                <select class="form-select-custom" id="dollarType" onchange="updateTotal()">
                    <option value="new">New Gmail (Level Rate)</option>
                    <option value="old">Old Gmail (Level Rate)</option>
                </select>
            </div>

            <button class="trans-btn" id="startTransBtn" onclick="protectedAction('exchange')">Next Step <i class="bi bi-arrow-right-circle ms-2"></i></button>
        </div>

        <!-- Redesigned Review Time Card -->
        <div class="home-card review-time-card">
            <div class="rtc-left">
                <div class="rtc-icon-box">
                    <i class="bi bi-clock-history"></i>
                </div>
                <div class="rtc-info">
                    <h6>Review Time</h6>
                    <h4 id="reviewTimeTitle">1 - 6 Hours</h4>
                </div>
            </div>
            <div class="rtc-right">
                <div class="rtc-status-badge">
                    <div class="pulse-dot"></div> LIVE
                </div>
                <div class="rtc-clock-text" id="liveClock">00:00 PM</div>
            </div>
        </div>

        <!-- Trust Box New -->
        <div class="home-card trust-box-new">
            <div class="tbn-title"><i class="bi bi-shield-check text-primary"></i> ‡¶ï‡ßá‡¶® ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶¨‡ßá‡¶®?</div>
            <div class="tbn-grid">
                <div class="tbn-item">
                    <div class="tbn-icon t1"><i class="bi bi-lightning-charge-fill"></i></div>
                    <div class="tbn-text">‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</div>
                </div>
                <div class="tbn-item">
                    <div class="tbn-icon t2"><i class="bi bi-shield-lock-fill"></i></div>
                    <div class="tbn-text">‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶°‡¶æ‡¶ü‡¶æ</div>
                </div>
                <div class="tbn-item">
                    <div class="tbn-icon t3"><i class="bi bi-headset"></i></div>
                    <div class="tbn-text">‡ß®‡ß™/‡ß≠ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü</div>
                </div>
            </div>
        </div>
    </div>

    <!-- EXCHANGE STEP -->
    <div id="exchange_step" class="content-section">
        <div class="d-flex align-items-center mb-3">
            <button class="btn btn-sm btn-light me-2 rounded-circle shadow-sm" onclick="switchTab('home')" style="width:32px; height:32px; padding:0;"><i class="bi bi-chevron-left"></i></button>
            <h6 class="mb-0 fw-bold text-dark">Enter Gmail Details : </h6>
        </div>
        
        <div class="alert alert-info py-2 px-3 d-flex justify-content-between align-items-center mb-3" style="border-radius:10px; font-size:13px;">
            <span>View Your Level Rate:</span>
            <b id="currentRateDisplay">10 ‡¶ü‡¶æ‡¶ï‡¶æ</b>
        </div>

        <form id="gmailForm">
            <div id="gmailRows"></div>
            <button type="button" class="btn btn-outline-primary btn-sm mb-3 w-100 py-2" style="border-radius:10px;" onclick="addMoreRow()"><i class="bi bi-plus-circle me-1"></i>Add Another</button>
            <div class="card p-3 mb-3 bg-white border text-center shadow-sm" style="border-radius:12px;">
                <small class="text-muted" style="font-size:11px;">Estimated Earnings</small>
                <h3 class="mb-0 fw-bold text-success">‡ß≥ <span id="tempTotal">0</span></h3>
            </div>
            <div id="masterError" class="alert alert-danger py-2 text-center fw-bold" style="display:none; border-radius:10px; font-size:12px;"></div>
            <button type="button" id="submitBtn" class="trans-btn" onclick="validateAndSubmit()"><span id="btnText">Submit Details</span><span id="btnLoad" class="spinner-border spinner-border-sm d-none"></span></button>
        </form>
    </div>

    <!-- HISTORY PAGE -->
    <div id="history" class="content-section">
        <div class="history-tabs-container">
            <div class="history-tabs">
                <button class="h-tab-btn active" onclick="showHistoryTab('sub', event)"><i class="bi bi-list-check"></i> Submissions</button>
                <button class="h-tab-btn" onclick="showHistoryTab('wd', event)"><i class="bi bi-cash-stack"></i> Withdraws</button>
                <button class="h-tab-btn" onclick="showHistoryTab('trend', event)"><i class="bi bi-fire"></i> Trending</button>
            </div>
        </div>
        <div id="broadcastBox" class="alert alert-warning py-2 shadow-sm border-0 d-flex align-items-center mb-3" style="display:none; border-radius:12px;"><i class="bi bi-megaphone-fill me-2 text-danger fs-5"></i><span id="broadcastText" class="fw-bold text-dark small"></span></div>
        
        <div id="history_sub"><div class="card border-0 shadow-sm" style="border-radius:12px;"><ul class="list-group list-group-flush" id="historyList" style="border-radius:12px;"><li class="list-group-item text-center text-muted py-4 border-0">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</li></ul></div></div>
        <div id="history_wd" style="display:none;"><div class="card border-0 shadow-sm"><ul class="list-group list-group-flush" id="withdrawHistoryList"><li class="list-group-item text-center text-muted py-4 border-0">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</li></ul></div></div>
        <div id="history_trend" style="display:none;"><div id="trendingList"></div></div>
    </div>

    <!-- SELLERS -->
    <div id="sellers" class="content-section">
        <h5 class="mb-3 text-center fw-bold text-dark">üèÜ Top Sellers</h5>
        <div id="topSellersList"></div>
    </div>

    <!-- PROFILE -->
    <div id="profile" class="content-section">
        <div class="profile-header">
            <div class="ph-logo-custom">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="white"/>
                    <path d="M2 17L12 22L22 17" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M2 12L12 17L22 12" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <div class="ph-name" id="userDisplayName">User</div>
            <span class="badge bg-light text-primary px-3 py-1 rounded-pill shadow-sm" id="levelNameDisplay">Level 1</span>
        </div>

        <div class="balance-card-profile container">
            <div class="text-center bal-main">
                <div class="bal-icon-box mx-auto"><i class="bi bi-wallet2"></i></div>
                <small class="text-muted d-block">Main Balance</small>
                <h3 class="fw-bold text-primary mb-0">‡ß≥ <span id="mainBalance">0.00</span></h3>
            </div>
            <div class="text-center bal-hold">
                <div class="bal-icon-box mx-auto"><i class="bi bi-hourglass-split"></i></div>
                <small class="text-muted d-block">Hold Balance</small>
                <h3 class="fw-bold text-warning mb-0">‡ß≥ <span id="holdBalance">0.00</span></h3>
            </div>
        </div>

        <div class="container" style="padding-top: 0;">
            <button class="withdraw-main-btn" onclick="window.openWithdrawPage()">
                <i class="bi bi-cash-stack"></i> Withdraw Funds üí∏
            </button>

            <div class="card stats-card-mobile">
                <div class="card-body p-3">
                    <h6 class="text-muted text-uppercase mb-3 small">Submission Status üîî</h6>
                    <div class="row g-3">
                        <div class="col-6"><div class="stat-box total"><span class="val" id="statTotal">0</span><span class="label">Total</span></div></div>
                        <div class="col-6"><div class="stat-box app"><span class="val" id="statApproved">0</span><span class="label">Approved</span></div></div>
                        <div class="col-6"><div class="stat-box pend"><span class="val" id="statPending">0</span><span class="label">Pending</span></div></div>
                        <div class="col-6"><div class="stat-box rej"><span class="val" id="statRejected">0</span><span class="label">Rejected</span></div></div>
                    </div>
                </div>
            </div>

            <div class="level-card">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 fw-bold">Level Progress</h6>
                    <span class="level-rate-badge" style="background: #e0e7ff; color: #3730a3; padding: 4px 10px; border-radius: 8px; font-weight: 700; font-size: 13px;"><span id="levelCurrentRate">10</span> ‡ß≥/ Gmail </span>
                </div>
                <small class="text-muted">Approved: <span id="levelTotalApproved">0</span></small>
                <div class="progress mt-2" style="height: 8px; border-radius: 10px; background: #f3f4f6;">
                    <div class="progress-bar bg-primary" id="levelProgressBar" style="width: 0%"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <span class="small text-muted">Current Level</span>
                    <span class="small fw-bold text-primary" id="levelRemainCount">Next: 40 Left</span>
                </div>
            </div>

            <div class="referral-card-new">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-gift-fill fs-3 me-3"></i>
                    <div>
                        <h6 class="mb-0 fw-bold">Invite & Earn</h6>
                        <small style="opacity: 0.8">Commission: <span id="commRateDisplay">0</span>%</small>
                    </div>
                </div>
                <div class="ref-stats-grid">
                    <div>
                        <div class="ref-stat-val" id="totalReferred">0</div>
                        <div class="ref-stat-label">Total Refers</div>
                    </div>
                    <div>
                        <div class="ref-stat-val">‡ß≥ <span id="referralEarnings">0.00</span></div>
                        <div class="ref-stat-label">Total Earned</div>
                    </div>
                </div>
                <div class="ref-input-group">
                    <div class="flex-grow-1">
                        <small class="d-block" style="font-size:10px; opacity:0.8">Your Code</small>
                        <span class="ref-code-text" id="myReferralCode">LOADING</span>
                    </div>
                    <button class="btn btn-light btn-sm px-3" onclick="window.copyRefLink()"><i class="bi bi-clipboard-check"></i> Copy</button>
                </div>
                <input type="hidden" id="refLinkInput" value="Loading...">
            </div>

            <!-- SETTINGS & SECURITY SECTION -->
            <div class="settings-card">
                <div class="settings-item" onclick="window.openSupport()">
                    <i class="bi bi-headset text-primary"></i>
                    <div class="text">
                        <h6>Live Support</h6>
                        <small>Contact us via Telegram</small>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                </div>
                <div class="settings-item" onclick="window.showChangePasswordModal()">
                    <i class="bi bi-key text-warning"></i>
                    <div class="text">
                        <h6>Change Password</h6>
                        <small>Update your account password</small>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                </div>
                <div class="settings-item" onclick="window.logoutAllDevices()">
                    <i class="bi bi-phone text-info"></i>
                    <div class="text">
                        <h6>Logout All Devices</h6>
                        <small>Secure your account remotely</small>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                </div>
                <div class="settings-item danger" onclick="window.handleDeleteAccount()">
                    <i class="bi bi-person-x"></i>
                    <div class="text">
                        <h6>Delete Account</h6>
                        <small>Permanently delete your data</small>
                    </div>
                    <i class="bi bi-chevron-right text-muted"></i>
                </div>
            </div>

            <button class="btn btn-outline-danger w-100 btn-sm rounded-pill py-2 mb-5" onclick="window.handleLogout()">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
            </button>
        </div>
    </div>
</div>

<div class="nav-bottom shadow">
    <div class="nav-item active" id="home-btn" onclick="switchTab('home')"><i class="bi bi-house-door"></i><span>Home</span></div>
    <div class="nav-item" id="history-btn" onclick="protectedAction('history')"><i class="bi bi-clock-history"></i><span>History</span></div>
    <div class="nav-item" id="sellers-btn" onclick="switchTab('sellers')"><i class="bi bi-star"></i><span>Seller</span></div>
    <div class="nav-item" id="profile-btn" onclick="protectedAction('profile')"><i class="bi bi-person"></i><span>Profile</span></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail, updatePassword, reauthenticateWithCredential, EmailAuthProvider, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getDatabase, ref, set, get, update, push, onValue, increment, query, orderByChild, equalTo, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAbsa0uvBYhkEYoLxuHwD4TQi5GDdAzQpg",
    authDomain: "exchanger-pro.firebaseapp.com",
    databaseURL: "https://exchanger-pro-default-rtdb.firebaseio.com",
    projectId: "exchanger-pro",
    storageBucket: "exchanger-pro.firebasestorage.app",
    messagingSenderId: "889959520630",
    appId: "1:889959520630:web:f4cbf82f236b616e1f8257"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  window.currentUser = null;
  const urlParams = new URLSearchParams(window.location.search);
  const referrerCodeParam = urlParams.get('ref');
  
  window.currentDynamicRate = 10; 
  window.baseOldRate = 8;
  let currentUserApprovedCount = 0;
  let lastBroadcastMessage = "";

  const levels = [
      { level: 1, approved: 0, rate: 10 },
      { level: 2, approved: 40, rate: 12 },
      { level: 3, approved: 90, rate: 12.50 },
      { level: 4, approved: 180, rate: 13 },
      { level: 5, approved: 290, rate: 13.50 },
      { level: 6, approved: 390, rate: 14 },
      { level: 7, approved: 510, rate: 14.50 }
  ];

  function getDeviceInfo() {
      const ua = navigator.userAgent;
      if (/android/i.test(ua)) return "Android Device";
      if (/iPad|iPhone|iPod/.test(ua)) return "iOS Device";
      if (/Win/.test(ua)) return "Windows PC";
      if (/Mac/.test(ua)) return "Macintosh";
      if (/Linux/.test(ua)) return "Linux";
      return "Unknown Device";
  }

  function getUserLevel(totalApproved) {
      let currentLevel = levels[0];
      let nextLevel = levels[1];
      for (let i = 0; i < levels.length; i++) {
          if (totalApproved >= levels[i].approved) {
              currentLevel = levels[i];
              if (i + 1 < levels.length) nextLevel = levels[i + 1];
              else nextLevel = null;
          }
      }
      return { current: currentLevel, next: nextLevel };
  }
  
  function syncRatesAndTotal() {
      const levelData = getUserLevel(currentUserApprovedCount);
      window.currentDynamicRate = levelData.current.rate;
      
      const rateDisplay = document.getElementById('currentRateDisplay');
      if(rateDisplay) rateDisplay.innerText = window.currentDynamicRate + " ‡¶ü‡¶æ‡¶ï‡¶æ";
      
      const homeTitle = document.getElementById('homeLevelTitle');
      const homeRateNew = document.getElementById('rateNew');
      
      if(window.currentUser) {
          if(homeTitle) homeTitle.innerText = `Level ${levelData.current.level} Rate`;
          if(homeRateNew) homeRateNew.innerHTML = `${window.currentDynamicRate} <small>‡¶ü‡¶æ‡¶ï‡¶æ</small>`;
      } else {
          if(homeTitle) homeTitle.innerText = "Level 1 Rate";
      }
      
      updateTotal();
  }

  function showToast(icon, title) {
      const Toast = Swal.mixin({
          toast: true, position: 'bottom-start', showConfirmButton: false, timer: 3000, timerProgressBar: true,
          didOpen: (toast) => { toast.addEventListener('mouseenter', Swal.stopTimer); toast.addEventListener('mouseleave', Swal.resumeTimer); }
      });
      Toast.fire({ icon: icon, title: title });
  }

  function showPopup(icon, title, text) {
      Swal.fire({ icon: icon, title: title, text: text, confirmButtonColor: '#4F46E5', background: '#fff' });
  }

  function showError(title, msg) { showPopup('error', title, msg); }
  
  function getErrorReason(error) {
      let msg = "Unknown error occurred.";
      switch(error.code) {
          case 'auth/email-already-in-use': msg = 'This email is already in use.'; break;
          case 'auth/invalid-email': msg = 'Invalid email format.'; break;
          case 'auth/weak-password': msg = 'Password is too weak. Minimum 6 characters required.'; break;
          case 'auth/user-not-found': msg = 'No account found with this email.'; break;
          case 'auth/wrong-password': msg = 'Incorrect password.'; break;
          case 'auth/invalid-credential': msg = 'Invalid email or password.'; break;
          case 'auth/too-many-requests': msg = 'Too many failed attempts.'; break;
          case 'auth/requires-recent-login': msg = 'This operation is sensitive. Please login again to perform this action.'; break;
          default: msg = error.message || "An unexpected error occurred.";
      }
      return msg;
  }

  function updateClock() {
      const now = new Date();
      document.getElementById('liveClock').innerText = now.toLocaleTimeString('en-US', { hour12: true });
  }
  setInterval(updateClock, 1000);
  updateClock();

  onValue(ref(db, "settings"), (snap) => {
    if (snap.exists()) {
      const data = snap.val();
      
      const isMaintenance = data.maintenance_mode || false;
      const startBtn = document.getElementById('startTransBtn');
      const submitBtn = document.getElementById('submitBtn');
      
      if(isMaintenance) {
          if(startBtn) { startBtn.disabled = true; startBtn.innerHTML = "‚ö†Ô∏è ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶∏‡¶æ‡¶Æ‡¶Ø‡¶º‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡ßç‡¶•‡¶ó‡¶ø‡¶§‡•§ ‚è≥"; }
          if(submitBtn) { submitBtn.disabled = true; document.getElementById('btnText').innerText = "Maintenance Mode"; }
      } else {
          if(startBtn) { startBtn.disabled = false; startBtn.innerHTML = 'Continue <i class="bi bi-arrow-right-circle ms-2"></i>'; }
          if(submitBtn) { submitBtn.disabled = false; document.getElementById('btnText').innerText = "Submit Details"; }
      }

      const reviewText = data.review_time_text || "1 - 6 Hours";
      const reviewElement = document.getElementById('reviewTimeTitle');
      if(reviewElement) reviewElement.innerText = reviewText;

      if(data.levels) {
          Object.keys(data.levels).forEach(key => {
              const idx = levels.findIndex(l => l.level === parseInt(key));
              if(idx !== -1) {
                  levels[idx].rate = data.levels[key].new_rate;
                  levels[idx].approved = data.levels[key].req;
              }
          });
      }

      const nR = data.levels?.[1]?.new_rate || 10;
      const oR = data.levels?.[1]?.old_rate || 8;
      
      if (!window.currentUser) {
          document.getElementById('rateNew').innerHTML = `${nR} <small>‡¶ü‡¶æ‡¶ï‡¶æ</small>`;
      }
      document.getElementById('rateOld').innerHTML = `${oR} <small>‡¶ü‡¶æ‡¶ï‡¶æ</small>`;
      
      window.baseOldRate = oR;
      
      const commRate = data.commission_percent || 0;
      const commDisplay = document.getElementById('commRateDisplay');
      if(commDisplay) commDisplay.innerText = commRate;
      
      const minW = data.min_withdraw || 100;
      document.getElementById('wdMinLabel').innerText = `‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®: ${minW} ‡¶ü‡¶æ‡¶ï‡¶æ`;
      document.getElementById('wdAmount').setAttribute('min', minW);
      
      if(data.broadcast) {
          document.getElementById('broadcastText').innerText = data.broadcast;
          document.getElementById('broadcastBox').style.display = 'flex';
          if (data.broadcast !== lastBroadcastMessage) {
              Swal.fire({ icon: 'info', title: 'üì¢ Notifications', text: data.broadcast, confirmButtonColor: '#4F46E5' });
              lastBroadcastMessage = data.broadcast;
          }
      } else {
          document.getElementById('broadcastBox').style.display = 'none';
          lastBroadcastMessage = "";
      }
      syncRatesAndTotal();
    }
  });

  function renderSellers(snap, containerId) {
      const list = document.getElementById(containerId);
      let htmlContent = '';
      const users = [];
      snap.forEach((child) => { const u = child.val(); if (u.isTopSeller === true) users.push(u); });
      users.sort((a, b) => (Number(b.balance) || 0) - (Number(a.balance) || 0));
      users.forEach((u, i) => {
        let badge = i === 0 ? 'ü•á' : (i === 1 ? 'ü•à' : (i === 2 ? 'ü•â' : ''));
        let rankClass = i === 0 ? 'gold' : (i === 1 ? 'silver' : '');
        htmlContent += `
          <div class="seller-card">
            <div class="seller-rank ${rankClass}">${badge || (i+1)}</div>
            <div class="seller-info"><div class="seller-name">${u.username}</div><div class="seller-income-label">Total Income</div></div>
            <div class="text-end"><div class="seller-amount">${(Number(u.balance) || 0).toFixed(0)} <small>BDT</small></div></div>
          </div>`;
      });
      if(users.length === 0) htmlContent = '<div class="text-center text-muted p-4">No sellers found</div>';
      list.innerHTML = htmlContent;
  }
  
  onValue(ref(db, "users"), (snap) => {
      renderSellers(snap, 'topSellersList');
      renderSellers(snap, 'trendingList');
  });

  onAuthStateChanged(auth, (user) => {
    window.currentUser = user;
    if (user) {
      onValue(ref(db, 'users/' + user.uid + '/forceLogout'), (snapshot) => {
          if(snapshot.exists() && snapshot.val() === true) {
              update(ref(db, 'users/' + user.uid), { forceLogout: false });
              signOut(auth);
              showPopup('info', 'Session Expired', 'You have been logged out from all devices.');
          }
      });

      onValue(ref(db, 'users/' + user.uid), (snap) => {
        if (snap.exists()) {
          const data = snap.val();
          
          if(data.admin_message) {
              showPopup('info', '‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ', data.admin_message);
              update(ref(db, 'users/' + user.uid), { admin_message: null });
          }

          if(data.is_blocked) { showPopup('error', 'Account Blocked', '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§'); signOut(auth); return; }

          document.getElementById('userDisplayName').innerText = data.username || "User";
          document.getElementById('mainBalance').innerText = (Number(data.balance) || 0).toFixed(2);
          document.getElementById('holdBalance').innerText = (Number(data.hold) || 0).toFixed(2);
          document.getElementById('wdMainBalance').innerText = (Number(data.balance) || 0).toFixed(2);
          document.getElementById('wdHoldBalance').innerText = (Number(data.hold) || 0).toFixed(2);
          
          const rCode = data.referralCode || "N/A";
          document.getElementById('myReferralCode').innerText = rCode;
          
          let host = window.location.origin; if(!host || host === 'null') host = 'https://exchanger-pro.web.app'; 
          document.getElementById('refLinkInput').value = host + window.location.pathname + "?ref=" + rCode;
          
          document.getElementById('referralEarnings').innerText = (Number(data.referralEarnings) || 0).toFixed(2);
          if (data.paymentNumber) document.getElementById('wdAccNumber').value = data.paymentNumber;
          if(data.paymentMethod) {
              document.querySelectorAll('.pm-card').forEach(c => c.classList.remove('active'));
              const card = document.querySelector(`.pm-card.${data.paymentMethod}`);
              if(card) card.classList.add('active');
              document.getElementById('selectedMethod').value = data.paymentMethod;
          }

          currentUserApprovedCount = data.manual_approved_count || 0;
          const levelData = getUserLevel(currentUserApprovedCount);
          window.currentDynamicRate = levelData.current.rate;
          
          document.getElementById('levelNameDisplay').innerText = `Level ${levelData.current.level}`;
          document.getElementById('levelCurrentRate').innerText = levelData.current.rate;
          document.getElementById('levelTotalApproved').innerText = currentUserApprovedCount;
          
          if(levelData.next) {
              document.getElementById('levelRemainCount').innerText = `${levelData.next.approved - currentUserApprovedCount} Left`;
              let progress = ((currentUserApprovedCount - levelData.current.approved) / (levelData.next.approved - levelData.current.approved)) * 100;
              document.getElementById('levelProgressBar').style.width = progress + '%';
          } else { document.getElementById('levelRemainCount').innerText = "MAX"; document.getElementById('levelProgressBar').style.width = '100%'; }
          
          syncRatesAndTotal();
        }
      });

      onValue(ref(db, 'users'), (snap) => {
          let cnt = 0; snap.forEach(c => { if(c.val().referredBy === user.uid) cnt++; });
          document.getElementById('totalReferred').innerText = cnt;
      });

      onValue(ref(db, 'submissions'), (snap) => {
          const list = document.getElementById('historyList'); list.innerHTML = '';
          let totalEmails = 0, pending = 0, approved = 0, rejected = 0;
          let submissions = [];
          snap.forEach(child => { let item = child.val(); if(item.userId === user.uid) { item.key = child.key; submissions.push(item); } });
          submissions.sort((a, b) => b.submittedAt - a.submittedAt);
          submissions.forEach(item => {
              const date = new Date(item.submittedAt).toLocaleString(); totalEmails += Number(item.count || 0);
              let detailsHTML = '';
              if(item.gmails && Array.isArray(item.gmails)){
                  item.gmails.forEach(g => {
                      let status = g.status || item.status || 'pending'; if (status === 'completed') status = 'approved';
                      if(status === 'pending' || status === 'checking') pending++; if(status === 'approved') approved++; if(status === 'rejected') rejected++;
                      let badgeClass = status === 'approved' ? 'bg-success' : (status === 'rejected' ? 'bg-danger' : 'bg-warning text-dark');
                      let statusText = status === 'checking' ? 'Checking' : status.charAt(0).toUpperCase() + status.slice(1);
                      detailsHTML += `<div class="d-flex justify-content-between mt-1 p-1 rounded bg-light small mb-1" style="font-size:11px;"><span class="text-truncate" style="max-width:120px;">${g.email}</span><span class="badge ${badgeClass}">${statusText}</span></div>`;
                  });
              }
              list.innerHTML += `<li class="list-group-item history-list-item border-0 bg-white mb-2 shadow-sm" style="border-radius:12px;"><div class="d-flex justify-content-between"><div class="fw-bold" style="color:var(--primary-color)">‡ß≥ ${item.totalAmount}</div><small class="text-muted">${item.count} Emails</small></div>${detailsHTML}<div class="text-muted small mt-1"><i class="bi bi-clock"></i> ${date}</div></li>`;
          });
          if(submissions.length === 0) list.innerHTML = '<li class="list-group-item text-center text-muted py-4 border-0">‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶æ‡¶¨‡¶Æ‡¶ø‡¶∂‡¶® ‡¶®‡ßá‡¶á</li>';
          document.getElementById('statTotal').innerText = totalEmails; document.getElementById('statPending').innerText = pending;
          document.getElementById('statApproved').innerText = approved; document.getElementById('statRejected').innerText = rejected;
      });

      onValue(ref(db, 'withdraw_requests'), (snap) => {
          const list = document.getElementById('withdrawHistoryList'); list.innerHTML = '';
          if(!snap.exists()) { list.innerHTML = '<li class="list-group-item text-center text-muted py-4 border-0">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</li>'; return; }
          let requests = []; snap.forEach(c => { const val = c.val(); if(val.userId === user.uid) requests.push(val); });
          requests.sort((a, b) => b.requestedAt - a.requestedAt);
          if(requests.length === 0) { list.innerHTML = '<li class="list-group-item text-center text-muted py-4 border-0">‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á</li>'; return; }
          requests.forEach(r => {
              let statusBadge = r.status === 'approved' ? '<span class="badge bg-success rounded-pill">Approved</span>' : (r.status === 'rejected' ? '<span class="badge bg-danger rounded-pill">Rejected</span>' : '<span class="badge bg-warning text-dark rounded-pill">Pending</span>');
              list.innerHTML += `<li class="list-group-item history-list-item border-0 bg-white mb-2 shadow-sm" style="border-radius:12px;"><div class="d-flex justify-content-between align-items-center"><div><b style="color:var(--primary-color)">${r.amount} BDT</b> <small class="text-muted d-block">${new Date(r.requestedAt).toLocaleDateString()}</small></div><div class="text-end">${statusBadge}<br><small class="text-muted">${r.method}</small></div></div></li>`;
          });
      });
      document.getElementById('auth-page').style.display = 'none';
    }
  });

  window.handleLogin = async () => {
    const email = document.getElementById('loginEmail').value.trim(); const pass = document.getElementById('loginPass').value;
    const btn = document.getElementById('loginBtn'); const btnText = document.getElementById('loginBtnText'); const btnSpinner = document.getElementById('loginBtnSpinner');
    if(!email) { showError("Input Error", "Please enter your email."); return; } if(!pass) { showError("Input Error", "Please enter your password."); return; }
    btn.disabled = true; btnText.innerText = "Checking..."; btnSpinner.classList.remove('d-none');
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      if(auth.currentUser) await update(ref(db, 'users/' + auth.currentUser.uid), { last_login: Date.now(), device: getDeviceInfo(), forceLogout: false });
      showPopup('success', 'Login Successful', 'Welcome to Exchanger Pro!'); switchTab('home');
    } catch (err) { showError("Login Failed", getErrorReason(err)); btn.disabled = false; btnText.innerText = "Login"; btnSpinner.classList.add('d-none'); }
  };

  window.handleRegister = async () => {
    const name = document.getElementById('regName').value.trim(); const email = document.getElementById('regEmail').value.trim(); const pass = document.getElementById('regPass').value; const confirmPass = document.getElementById('regConfirmPass').value;
    const btn = document.getElementById('regBtn'); const btnText = document.getElementById('regBtnText'); const btnSpinner = document.getElementById('regBtnSpinner');
    if (!name) { showError("Input Error", "Please enter your name."); return; } if (!/^[a-zA-Z\s]+$/.test(name)) { showError("Invalid Name", "Name can only contain letters."); return; }
    if (!email) { showError("Input Error", "Please enter your email."); return; } if (!/^[a-zA-Z0-9._%+-]+@gmail\.com$/.test(email)) { showError("Invalid Email", "Only valid Gmail addresses are allowed."); return; }
    if (pass.length < 6) { showError("Weak Password", "Password must be at least 6 characters."); return; } if (pass !== confirmPass) { showError("Validation Error", "Passwords do not match."); return; }
    btn.disabled = true; btnText.innerText = "Initializing..."; btnSpinner.classList.remove('d-none');
    try {
      const settingsSnap = await get(ref(db, 'settings')); const settings = settingsSnap.exists() ? settingsSnap.val() : {};
      const bonusUser = Number(settings.signup_bonus_user) || 0; const bonusReferrer = Number(settings.signup_bonus_referrer) || 0;
      btnText.innerText = "Creating account...";
      const res = await createUserWithEmailAndPassword(auth, email, pass);
      const myRefCode = Math.random().toString(36).substring(2, 8).toUpperCase(); let referrerId = null;
      if(referrerCodeParam) {
          btnText.innerText = "Validating referral..."; try { const q = query(ref(db, 'users'), orderByChild('referralCode'), equalTo(referrerCodeParam)); const snapshot = await get(q); if (snapshot.exists()) snapshot.forEach(child => { referrerId = child.key; }); } catch (e) {}
      }
      btnText.innerText = "Saving data...";
      await set(ref(db, 'users/' + res.user.uid), { username: name, email, balance: bonusUser, hold: 0, paymentNumber: "", paymentMethod: "", createdAt: Date.now(), referralCode: myRefCode, referredBy: referrerId || "", referralEarnings: 0, last_login: Date.now(), device: getDeviceInfo(), forceLogout: false });
      if(referrerId && bonusReferrer > 0) { await update(ref(db, 'users/' + referrerId), { balance: increment(bonusReferrer), referralEarnings: increment(bonusReferrer) }); }
      Swal.fire({ icon: 'success', title: 'üéâ ‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®!', html: `‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§<br>‡¶Ü‡¶™‡¶®‡¶ø <b style="color:#4F46E5">${bonusUser} ‡¶ü‡¶æ‡¶ï‡¶æ</b> ‡¶¨‡ßã‡¶®‡¶æ‡¶∏ ‡¶™‡ßá‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡¶®!`, confirmButtonColor: '#4F46E5' }).then(() => { location.reload(); });
    } catch (err) { showError("Registration Failed", getErrorReason(err)); btn.disabled = false; btnText.innerText = "Register / Sign Up"; btnSpinner.classList.add('d-none'); }
  };

  window.handleLogout = () => signOut(auth).then(() => location.reload());

  // Support Link
  window.openSupport = () => window.open('http://t.me/gmail_marketing02', '_blank');

  window.logoutAllDevices = async () => {
      if(!window.currentUser) return;
      Swal.fire({ title: 'Logout All Devices?', text: "You will be logged out from this device too.", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', cancelButtonColor: '#3085d6', confirmButtonText: 'Yes, logout all!' }).then(async (result) => {
          if (result.isConfirmed) { await update(ref(db, 'users/' + window.currentUser.uid), { forceLogout: true }); signOut(auth); }
      });
  };

  window.showChangePasswordModal = () => {
      Swal.fire({
          title: 'Change Password', html: '<input id="swal-curr-pass" type="password" class="swal2-input" placeholder="Current Password"><input id="swal-new-pass" type="password" class="swal2-input" placeholder="New Password (min 6 chars)">',
          confirmButtonText: 'Update', focusConfirm: false,
          preConfirm: () => {
              const currPass = document.getElementById('swal-curr-pass').value; const newPass = document.getElementById('swal-new-pass').value;
              if (!currPass || !newPass) { Swal.showValidationMessage('Please enter both fields'); return false; }
              if(newPass.length < 6) { Swal.showValidationMessage('New password must be at least 6 characters'); return false; }
              return { currPass, newPass };
          }
      }).then(async (result) => {
          if (result.isConfirmed) {
              const { currPass, newPass } = result.value; const user = auth.currentUser; const credential = EmailAuthProvider.credential(user.email, currPass);
              try { Swal.fire({ title: 'Updating...', didOpen: () => { Swal.showLoading(); } }); await reauthenticateWithCredential(user, credential); await updatePassword(user, newPass); showPopup('success', 'Success', 'Password updated successfully!'); } catch (error) { showError("Error", getErrorReason(error)); }
          }
      });
  };

  window.handleDeleteAccount = async () => {
      if(!window.currentUser) return;
      Swal.fire({ title: 'Delete Account?', text: "This action is irreversible. All your data will be lost.", icon: 'warning', input: 'password', inputPlaceholder: 'Enter your password to confirm', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Delete My Account' }).then(async (result) => {
          if (result.isConfirmed) {
              const pass = result.value; const user = auth.currentUser; const credential = EmailAuthProvider.credential(user.email, pass);
              try { Swal.fire({ title: 'Deleting...', didOpen: () => { Swal.showLoading(); } }); await reauthenticateWithCredential(user, credential); await remove(ref(db, 'users/' + user.uid)); await deleteUser(user); showPopup('success', 'Deleted', 'Your account has been deleted.'); } catch (error) { showError("Error", getErrorReason(error)); }
          }
      });
  };

  window.copyRefLink = () => {
      const linkInput = document.getElementById('refLinkInput'); const link = linkInput.value;
      if(!link || link === 'Loading...') { showError("Wait", "Profile data loading..."); return; }
      const tempInput = document.createElement('input'); tempInput.style.position = 'absolute'; tempInput.style.left = '-9999px'; tempInput.value = link; document.body.appendChild(tempInput); tempInput.select(); tempInput.setSelectionRange(0, 99999);
      try { const successful = document.execCommand('copy'); if (successful) showToast('success', '‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!'); else throw new Error('Copy failed'); } catch (err) { showError("Copy Failed", "Please manually copy the link."); }
      document.body.removeChild(tempInput);
  };

  window.submitGmails = async (submissionData) => {
    const btn = document.getElementById('submitBtn'); const btnText = document.getElementById('btnText'); const btnLoad = document.getElementById('btnLoad');
    btn.disabled = true; btnText.innerText = "Processing..."; btnLoad.classList.remove('d-none');
    try {
      for (let item of submissionData.gmails) {
        const q = query(ref(db, 'used_emails'), orderByChild('email'), equalTo(item.email)); const emailSnap = await get(q);
        if (emailSnap.exists()) { btn.disabled = false; btnText.innerText = "Confirm & Submit"; btnLoad.classList.add('d-none'); return showError("Duplicate Entry", item.email + " has already been submitted."); }
      }
      const newRef = push(ref(db, 'submissions')); await set(newRef, { userId: currentUser.uid, username: document.getElementById('userDisplayName').innerText, submittedAt: Date.now(), status: "pending", ...submissionData });
      for (let item of submissionData.gmails) await push(ref(db, 'used_emails'), { email: item.email });
      const userRef = ref(db, 'users/' + currentUser.uid); const userSnap = await get(userRef); const userData = userSnap.val();
      await update(userRef, { hold: (Number(userData.hold) || 0) + submissionData.totalAmount });
      showPopup('success', 'Success', 'Submission recorded.'); location.reload();
    } catch (err) { btn.disabled = false; btnText.innerText = "Confirm & Submit"; btnLoad.classList.add('d-none'); showError("Server Error", err.message); }
  };

  window.processWithdraw = async () => {
    const method = document.getElementById('selectedMethod').value; const amt = Number(document.getElementById('wdAmount').value); const balance = Number(document.getElementById('wdMainBalance').innerText); const pNum = document.getElementById('wdAccNumber').value.trim(); const minW = Number(document.getElementById('wdAmount').getAttribute('min'));
    if (!pNum) return showError("Missing Number", "Account number is required.");
    if (!amt || amt < minW) return showError("Invalid Amount", `Minimum amount is ${minW} BDT.`);
    if (amt > balance) return showError("Insufficient Balance", `You have ${balance} BDT.`);
    try {
        await push(ref(db, 'withdraw_requests'), { userId: currentUser.uid, username: document.getElementById('userDisplayName').innerText, amount: amt, method, paymentNumber: pNum, status: "pending", requestedAt: Date.now() });
        await update(ref(db, 'users/' + currentUser.uid), { balance: balance - amt, paymentNumber: pNum, paymentMethod: method });
        showPopup('success', 'Success', 'Request Submitted.'); window.closeWithdrawPage(); location.reload();
    } catch(e) { showError("Database Error", "Could not connect."); }
  };

  window.openWithdrawPage = () => { document.getElementById('withdraw-page').style.display = 'block'; document.querySelector('.page-container').style.display = 'none'; document.querySelector('.nav-bottom').style.display = 'none'; };
  window.closeWithdrawPage = () => { document.getElementById('withdraw-page').style.display = 'none'; document.querySelector('.page-container').style.display = 'block'; document.querySelector('.nav-bottom').style.display = 'flex'; };
  window.selectPaymentMethod = (el, method) => { document.querySelectorAll('.pm-card').forEach(c => c.classList.remove('active')); el.classList.add('active'); document.getElementById('selectedMethod').value = method; };

</script>

<script>
    // UI Logic
    function switchTab(tabId) {
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        if(document.getElementById(tabId + '-btn')) document.getElementById(tabId + '-btn').classList.add('active');
    }

    function showHistoryTab(tab, e) {
        document.querySelectorAll('.h-tab-btn').forEach(b => b.classList.remove('active'));
        if(e && e.target) e.target.closest('.h-tab-btn').classList.add('active');
        document.getElementById('history_sub').style.display = tab === 'sub' ? 'block' : 'none';
        document.getElementById('history_wd').style.display = tab === 'wd' ? 'block' : 'none';
        document.getElementById('history_trend').style.display = tab === 'trend' ? 'block' : 'none';
    }

    function protectedAction(tabId) {
        if (!window.currentUser) document.getElementById('auth-page').style.display = 'block';
        else if (tabId === 'exchange') switchTab('exchange_step');
        else switchTab(tabId);
    }
    
    function toggleAuth(type) {
        document.getElementById('login-form').style.display = type === 'reg' ? 'none' : 'block';
        document.getElementById('reg-form').style.display = type === 'reg' ? 'block' : 'none';
        document.getElementById('login-header-content').style.display = type === 'reg' ? 'none' : 'block';
        document.getElementById('reg-header-content').style.display = type === 'reg' ? 'block' : 'none';
    }

    document.addEventListener('DOMContentLoaded', () => { addMoreRow(); addMoreRow(); });

    function addMoreRow(email='', pass='') {
        const row = document.createElement('div');
        row.className = 'gmail-row position-relative';
        row.innerHTML = `<button type="button" class="remove-btn" onclick="removeRow(this)"><i class="bi bi-x"></i></button><input type="email" class="g-input" value="${email}" placeholder="Enter Gmail Address" required><input type="text" class="p-input" value="${pass}" placeholder="Enter Password" required>`;
        document.getElementById('gmailRows').appendChild(row);
        updateTotal();
    }

    function removeRow(element) {
        const rows = document.querySelectorAll('.gmail-row');
        if (rows.length <= 2) { showError("Warning", "Minimum 2 emails required."); return; }
        element.parentElement.remove();
        updateTotal();
    }

    function updateTotal() {
        const count = document.querySelectorAll('.gmail-row').length;
        const type = document.getElementById('dollarType').value;
        const rate = (type === 'new') ? (window.currentDynamicRate || 10) : (window.baseOldRate || 8);
        document.getElementById('tempTotal').innerText = count * rate;
    }

    function validateAndSubmit() {
        const rows = document.querySelectorAll('.gmail-row');
        if (rows.length < 2) { return showError("Validation Error", "Minimum 2 emails required."); }

        const gmails = []; let hasError = false; const localSet = new Set(); const emailRegex = /^[a-zA-Z0-9._%+-]+@gmail\.com$/;

        rows.forEach((row, idx) => {
            const email = row.querySelector('.g-input').value.trim().toLowerCase(); const pass = row.querySelector('.p-input').value.trim();
            if (!email || !pass) { hasError = true; showError("Input Error", `Row ${idx+1} fields cannot be empty.`); }
            else if (!emailRegex.test(email)) { hasError = true; showError("Invalid Email", `Row ${idx+1} is not a valid Gmail.`); }
            else if (pass.length < 6) { hasError = true; showError("Weak Password", `Row ${idx+1} password too short.`); }
            else if (localSet.has(email)) { hasError = true; showError("Duplicate", `${email} entered twice.`); }
            if (!hasError) { localSet.add(email); gmails.push({ email, password: pass }); }
        });

        if (!hasError) {
            const type = document.getElementById('dollarType').value;
            let rate = (type === 'new') ? (window.currentDynamicRate || 10) : (window.baseOldRate || 8);
            window.submitGmails({ gmails, totalAmount: gmails.length * rate, rate, count: gmails.length });
        }
    }
    
    function showError(title, msg) { Swal.fire({ icon: 'error', title: title, text: msg, confirmButtonColor: '#4F46E5' }); }
</script>

</body>
</html>